<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test LG-044: Sincronizaci√≥n de Carrito | Level-Up Gamer</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-button.success {
            background: #28a745;
        }
        
        .test-button.warning {
            background: #ffc107;
            color: #000;
        }
        
        .test-button.danger {
            background: #dc3545;
        }
        
        .status-display {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .sync-info {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }
        
        .cart-display {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-counter {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .test-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <header class="test-section">
            <h1>üß™ Test LG-044: Sincronizaci√≥n de Carrito con localStorage</h1>
            <p>Pruebas de persistencia y sincronizaci√≥n cross-tab del sistema de carrito</p>
            
            <div class="sync-info">
                <strong>üîÑ Estado de Sincronizaci√≥n:</strong>
                <div id="syncStatus">Inicializando...</div>
            </div>
        </header>

        <section class="test-section">
            <h2>üìã Instrucciones de Prueba</h2>
            <div class="test-instructions">
                <h3>üéØ Objetivo: Validar persistencia en recarga y sincronizaci√≥n cross-tab</h3>
                <ol>
                    <li><strong>Agregar productos:</strong> Usar botones para agregar items al carrito</li>
                    <li><strong>Recargar p√°gina:</strong> Verificar que el carrito persiste</li>
                    <li><strong>Abrir nueva pesta√±a:</strong> Abrir esta misma p√°gina en otra pesta√±a</li>
                    <li><strong>Modificar carrito:</strong> Cambiar carrito en una pesta√±a</li>
                    <li><strong>Verificar sincronizaci√≥n:</strong> Ver cambios reflejados en otras pesta√±as</li>
                </ol>
            </div>
        </section>

        <div class="test-grid">
            <section class="test-section">
                <h2>üõí Gesti√≥n de Carrito</h2>
                
                <h3>Agregar Productos de Prueba</h3>
                <button class="test-button" onclick="addTestProduct('game1')">
                    Agregar Cyberpunk 2077 - $59.990
                </button>
                <button class="test-button" onclick="addTestProduct('game2')">
                    Agregar The Last of Us Part II - $49.990
                </button>
                <button class="test-button" onclick="addTestProduct('console1')">
                    Agregar PlayStation 5 - $699.990
                </button>
                
                <h3>Modificaciones</h3>
                <button class="test-button warning" onclick="changeQuantity('game1', 2)">
                    Cambiar cantidad Cyberpunk x2
                </button>
                <button class="test-button danger" onclick="removeTestProduct('game2')">
                    Eliminar The Last of Us
                </button>
                <button class="test-button danger" onclick="clearCart()">
                    Vaciar Carrito
                </button>
                
                <h3>Sincronizaci√≥n Manual</h3>
                <button class="test-button" onclick="forceSyncTest()">
                    üîÑ Forzar Sincronizaci√≥n
                </button>
                <button class="test-button" onclick="testCrossTabSync()">
                    üì± Simular Cambio Cross-Tab
                </button>
            </section>

            <section class="test-section">
                <h2>üìä Estado Actual del Carrito</h2>
                
                <div class="cart-display" id="cartDisplay">
                    <div class="cart-item">
                        <span>Carrito vac√≠o</span>
                    </div>
                </div>
                
                <div class="status-display" id="cartStatus">
                    Items: 0
                    Subtotal: $0
                    Total: $0
                    √öltima actualizaci√≥n: --
                </div>
                
                <h3>üñ•Ô∏è Contadores en Navegaci√≥n</h3>
                <p>Contador Header: <span class="cart-counter" id="cartCount">0</span></p>
                <p>Badge Carrito: <span class="cart-counter" id="cartBadge">0</span></p>
            </section>
        </div>

        <section class="test-section">
            <h2>üìà Log de Eventos de Sincronizaci√≥n</h2>
            <button class="test-button" onclick="clearSyncLog()">üóëÔ∏è Limpiar Log</button>
            <div class="status-display" id="syncLog">
                Esperando eventos de sincronizaci√≥n...
            </div>
        </section>

        <section class="test-section">
            <h2>‚úÖ Resultados de Validaci√≥n</h2>
            <div id="validationResults">
                <p>üìã <strong>Checklist de Validaci√≥n LG-044:</strong></p>
                <ul id="validationChecklist">
                    <li id="check-persistence">‚è≥ Persistencia en recarga: Pendiente</li>
                    <li id="check-crosstab">‚è≥ Sincronizaci√≥n cross-tab: Pendiente</li>
                    <li id="check-counter">‚è≥ Actualizaci√≥n de contadores: Pendiente</li>
                    <li id="check-storage">‚è≥ Almacenamiento en localStorage: Pendiente</li>
                    <li id="check-realtime">‚è≥ Sincronizaci√≥n en tiempo real: Pendiente</li>
                </ul>
            </div>
        </section>
    </div>

    <!-- Scripts necesarios -->
    <script src="assets/js/products-database.js"></script>
    <script src="assets/js/cart.js"></script>

    <script>
        // Productos de prueba
        const TEST_PRODUCTS = {
            'game1': {
                id: 'game1',
                name: 'Cyberpunk 2077',
                price: 59990,
                image: 'assets/images/game1.jpg',
                category: 'games'
            },
            'game2': {
                id: 'game2', 
                name: 'The Last of Us Part II',
                price: 49990,
                image: 'assets/images/game2.jpg',
                category: 'games'
            },
            'console1': {
                id: 'console1',
                name: 'PlayStation 5',
                price: 699990,
                image: 'assets/images/ps5.jpg',
                category: 'consoles'
            }
        };

        let syncLogEntries = [];

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            updateAllDisplays();
            startSyncMonitoring();
            logSyncEvent('Sistema de carrito inicializado');
            
            // Validar persistencia si ya hay datos
            if (cartState.items.length > 0) {
                validatePersistence(true);
            }
        });

        // Funciones de prueba
        function addTestProduct(productId) {
            const product = TEST_PRODUCTS[productId];
            if (product) {
                addToCart(product.id, 1, product);
                logSyncEvent(`Producto agregado: ${product.name}`);
                updateAllDisplays();
                validateStorage();
            }
        }

        function removeTestProduct(productId) {
            removeFromCart(productId);
            logSyncEvent(`Producto eliminado: ${productId}`);
            updateAllDisplays();
            validateStorage();
        }

        function changeQuantity(productId, quantity) {
            updateQuantity(productId, quantity);
            logSyncEvent(`Cantidad actualizada: ${productId} x${quantity}`);
            updateAllDisplays();
            validateStorage();
        }

        function clearCart() {
            clearCartItems();
            logSyncEvent('Carrito vaciado completamente');
            updateAllDisplays();
            validateStorage();
        }

        function forceSyncTest() {
            loadCartFromStorage();
            updateAllDisplays();
            logSyncEvent('Sincronizaci√≥n forzada desde localStorage');
        }

        function testCrossTabSync() {
            // Simular cambio desde otra pesta√±a modificando localStorage directamente
            const fakeCartData = {
                items: [{
                    id: 'test-sync',
                    name: 'Producto Cross-Tab Test',
                    price: 29990,
                    quantity: 1,
                    image: 'test.jpg'
                }],
                lastUpdated: new Date().toISOString(),
                version: '2.0'
            };
            
            localStorage.setItem('levelup_cart', JSON.stringify(fakeCartData));
            
            // Disparar evento storage manualmente
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'levelup_cart',
                newValue: JSON.stringify(fakeCartData),
                oldValue: localStorage.getItem('levelup_cart')
            }));
            
            logSyncEvent('Simulado cambio cross-tab');
            setTimeout(() => {
                updateAllDisplays();
                validateCrossTab(true);
            }, 200);
        }

        // Monitoreo de sincronizaci√≥n
        function startSyncMonitoring() {
            // Override de funciones para logging
            const originalSaveCart = window.saveCartToStorage;
            const originalLoadCart = window.loadCartFromStorage;
            
            window.saveCartToStorage = function() {
                const result = originalSaveCart.call(this);
                if (result) {
                    logSyncEvent('Carrito guardado en localStorage');
                    validateStorage();
                }
                return result;
            };
            
            window.loadCartFromStorage = function() {
                originalLoadCart.call(this);
                logSyncEvent('Carrito cargado desde localStorage');
                validatePersistence(true);
            };
            
            // Monitorear eventos de storage
            window.addEventListener('storage', function(e) {
                if (e.key === 'levelup_cart') {
                    logSyncEvent('Evento storage detectado desde otra pesta√±a');
                    validateCrossTab(true);
                }
            });
            
            // Monitorear visibilidad de p√°gina
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    logSyncEvent('P√°gina enfocada - verificando sincronizaci√≥n');
                }
            });
        }

        // Actualizar displays
        function updateAllDisplays() {
            updateCartDisplay();
            updateCartStatus();
            updateSyncStatus();
            validateCounters();
        }

        function updateCartDisplay() {
            const display = document.getElementById('cartDisplay');
            
            if (cartState.items.length === 0) {
                display.innerHTML = '<div class="cart-item"><span>Carrito vac√≠o</span></div>';
            } else {
                display.innerHTML = cartState.items.map(item => `
                    <div class="cart-item">
                        <span><strong>${item.name}</strong> x${item.quantity}</span>
                        <span>${formatPrice(item.price * item.quantity)}</span>
                    </div>
                `).join('');
            }
        }

        function updateCartStatus() {
            const status = document.getElementById('cartStatus');
            status.textContent = `Items: ${cartState.itemCount}
Subtotal: ${formatPrice(cartState.subtotal)}
Total: ${formatPrice(cartState.total)}
√öltima actualizaci√≥n: ${cartState.lastUpdated || 'N/A'}`;
        }

        function updateSyncStatus() {
            const status = document.getElementById('syncStatus');
            const isHealthy = localStorage.getItem('levelup_cart') !== null;
            status.innerHTML = `
                <span style="color: ${isHealthy ? 'green' : 'red'}">
                    ${isHealthy ? '‚úÖ Conectado' : '‚ùå Desconectado'}
                </span>
                | Items en storage: ${JSON.parse(localStorage.getItem('levelup_cart') || '{"items":[]}').items.length}
                | Timestamp: ${new Date().toLocaleTimeString()}
            `;
        }

        // Logging
        function logSyncEvent(message) {
            const timestamp = new Date().toLocaleTimeString();
            syncLogEntries.push(`[${timestamp}] ${message}`);
            
            // Mantener solo los √∫ltimos 20 eventos
            if (syncLogEntries.length > 20) {
                syncLogEntries = syncLogEntries.slice(-20);
            }
            
            document.getElementById('syncLog').textContent = syncLogEntries.join('\n');
        }

        function clearSyncLog() {
            syncLogEntries = [];
            document.getElementById('syncLog').textContent = 'Log limpiado - esperando eventos...';
        }

        // Validaciones
        function validatePersistence(success) {
            const check = document.getElementById('check-persistence');
            check.innerHTML = success ? 
                '‚úÖ Persistencia en recarga: √âXITO' : 
                '‚ùå Persistencia en recarga: FALLO';
        }

        function validateCrossTab(success) {
            const check = document.getElementById('check-crosstab');
            check.innerHTML = success ? 
                '‚úÖ Sincronizaci√≥n cross-tab: √âXITO' : 
                '‚ùå Sincronizaci√≥n cross-tab: FALLO';
        }

        function validateCounters() {
            const headerCount = document.getElementById('cartCount');
            const badgeCount = document.getElementById('cartBadge');
            
            if (headerCount) {
                headerCount.textContent = cartState.itemCount;
            }
            if (badgeCount) {
                badgeCount.textContent = cartState.itemCount;
            }
            
            const check = document.getElementById('check-counter');
            check.innerHTML = '‚úÖ Actualizaci√≥n de contadores: √âXITO';
        }

        function validateStorage() {
            const stored = localStorage.getItem('levelup_cart');
            const check = document.getElementById('check-storage');
            
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    const hasValidStructure = data.items && Array.isArray(data.items);
                    check.innerHTML = hasValidStructure ? 
                        '‚úÖ Almacenamiento en localStorage: √âXITO' : 
                        '‚ùå Almacenamiento en localStorage: ESTRUCTURA INV√ÅLIDA';
                } catch (e) {
                    check.innerHTML = '‚ùå Almacenamiento en localStorage: JSON INV√ÅLIDO';
                }
            } else {
                check.innerHTML = '‚ö†Ô∏è Almacenamiento en localStorage: NO ENCONTRADO';
            }
        }

        // Actualizaci√≥n peri√≥dica
        setInterval(updateSyncStatus, 2000);
        setInterval(() => {
            const check = document.getElementById('check-realtime');
            check.innerHTML = '‚úÖ Sincronizaci√≥n en tiempo real: ACTIVA';
        }, 5000);
    </script>
</body>
</html>
